name: Genera versioni LeenO con archivio .oxt

on:
  push:
    branches: [dev]
  workflow_dispatch:

jobs:
  generate_version:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Installa dipendenze
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass  # Tool per SSH/SCP
          pip install requests

      - name: Recupera elenco file .oxt da SFTP
        id: get_oxt
        run: |
          sshpass -p "${{ secrets.SFTP_PASS }}" ssh \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.SFTP_PORT || 22 }} \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} \
            "ls -l --time-style=long-iso ${{ secrets.SFTP_REMOTE_PATH }}/*.oxt | sort -k 6,7 -r | head -10" > oxt_list.txt

          echo "=== File .oxt trovati ==="
          cat oxt_list.txt
          echo "::set-output name=count::$(grep -c '.oxt' oxt_list.txt)"

      - name: Genera file versione
        if: steps.get_oxt.outputs.count != '0'
        run: python tools/version/leeno_version_generator.py
        env:
          GITHUB_SHA: ${{ github.sha }}
          BUILD_NUMBER: ${{ github.run_number }}
          OXT_LIST_FILE: oxt_list.txt
        working-directory: ${{ github.workspace }}

      - name: Verifica file generati
        run: |
          echo "=== File generati ==="
          ls -la src/Ultimus.oxt/leeno_version_code
          ls -la include/version.h
          ls -la tools/version/versions.html
          echo "=== Anteprima HTML ==="
          head -n 25 tools/version/versions.html

      - name: Upload files
        run: |
          sshpass -p "${{ secrets.SFTP_PASS }}" scp \
            -o StrictHostKeyChecking=no \
            -P ${{ secrets.SFTP_PORT || 22 }} \
            src/Ultimus.oxt/leeno_version_code \
            include/version.h \
            tools/version/versions.html \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }}:${{ secrets.SFTP_REMOTE_PATH }}/

      - name: Verifica upload
        run: |
          echo "=== File remoti ==="
          sshpass -p "${{ secrets.SFTP_PASS }}" ssh \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.SFTP_PORT || 22 }} \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} \
            "ls -la ${{ secrets.SFTP_REMOTE_PATH }}/version.h \
                   ${{ secrets.SFTP_REMOTE_PATH }}/leeno_version_code \
                   ${{ secrets.SFTP_REMOTE_PATH }}/versions.html"
          echo "=== Anteprima HTML remoto ==="
          sshpass -p "${{ secrets.SFTP_PASS }}" ssh \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.SFTP_PORT || 22 }} \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} \
            "head -n 10 ${{ secrets.SFTP_REMOTE_PATH }}/versions.html"