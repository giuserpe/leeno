name: Genera versioni LeenO con WebDAV

on:
  push:
    branches: [dev]
  workflow_dispatch:

jobs:
  generate_version:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup ambiente
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          pip install requests
          mkdir -p src/Ultimus.oxt include tools/version

      - name: Recupera elenco .oxt da WebDAV
        id: webdav_files
        run: |
          # Configurazione da secret
          WEBDAV_URL="${{ secrets.MEDDAV_URL }}"
          WEBDAV_PATH="${{ secrets.STTP_REMOTE_PATH }}"
          AUTH="$(echo -n ${{ secrets.MEDDAV_USER }}:${{ secrets.MEDDAV_PASS }} | base64)"

          echo "=== Connessione a ${WEBDAV_URL}/${WEBDAV_PATH} ==="
          
          # 1. Lista file via PROPFIND
          curl -s -X PROPFIND \
            -H "Authorization: Basic $AUTH" \
            -H "Depth: 1" \
            "${WEBDAV_URL}/${WEBDAV_PATH}/" \
            -o webdav.xml

          # 2. Estrai solo file .oxt
          grep -Eo '<d:href>[^<]*\.oxt</d:href>' webdav.xml | 
            sed 's|<d:href>\(.*\)</d:href>|\1|' > oxt_urls.txt

          # 3. Recupera metadati
          echo "=== Metadati file ==="
          while read -r path; do
            filename=$(basename "$path")
            curl -s -I -H "Authorization: Basic $AUTH" "${WEBDAV_URL}${path}" | \
              awk -v fn="$filename" \
              '/Last-Modified:/ {date=$3" "$4" "$5} /Content-Length:/ {size=$2/1024} END {print date, size"KB", fn}'
          done < oxt_urls.txt | sort -r | head -10 > oxt_list.txt

          # Output
          OXT_COUNT=$(grep -c '.oxt' oxt_list.txt || echo 0)
          echo "count=$OXT_COUNT" >> $GITHUB_OUTPUT
          echo "list_path=${GITHUB_WORKSPACE}/oxt_list.txt" >> $GITHUB_OUTPUT
          echo "=== Trovati $OXT_COUNT file ==="
          cat oxt_list.txt

      - name: Genera file versione
        run: python tools/version/leeno_version_generator.py
        env:
          GITHUB_SHA: ${{ github.sha }}
          BUILD_NUMBER: ${{ github.run_number }}
          OXT_LIST_PATH: ${{ github.workspace }}/oxt_list.txt
          OXT_BASE_URL: "${{ secrets.MEDDAV_URL }}/${{ secrets.STTP_REMOTE_PATH }}"
          PUBLIC_DOWNLOAD_URL: "${{ secrets.PUBLIC_DOMNLOAD_BASE }}"  # Nota: correggi typo nel secret se possibile

      - name: Verifica output
        run: |
          echo "=== File generati ==="
          ls -la src/Ultimus.oxt/leeno_version_code include/version.h tools/version/versions.html
          echo "=== Anteprima HTML ==="
          grep -A 15 "Archivio Versioni" tools/version/versions.html || true

      - name: Upload a WebDAV
        if: steps.webdav_files.outputs.count > 0
        run: |
          AUTH="$(echo -n ${{ secrets.MEDDAV_USER }}:${{ secrets.MEDDAV_PASS }} | base64)"
          for file in src/Ultimus.oxt/leeno_version_code include/version.h tools/version/versions.html; do
            curl -X PUT \
              -H "Authorization: Basic $AUTH" \
              -T "$file" \
              "${{ secrets.MEDDAV_URL }}/${{ secrets.STTP_REMOTE_PATH }}/$(basename $file)"
          done
          
      - name: Debug WebDAV
        run: |
          echo "URL: ${{ secrets.MEDDAV_URL }}/${{ secrets.STTP_REMOTE_PATH }}"
          echo "File list:"
          curl -s -X PROPFIND -H "Authorization: Basic $(echo -n ${{ secrets.MEDDAV_USER }}:${{ secrets.MEDDAV_PASS }} | base64)" \
            "${{ secrets.MEDDAV_URL }}/${{ secrets.STTP_REMOTE_PATH }}/" | grep -Eo '<d:href>[^<]*</d:href>'