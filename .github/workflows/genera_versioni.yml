name: Genera pagina versioni LeenO

on:
  push:
    branches:
      - dev
  workflow_dispatch:

jobs:
  generate_version:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout codice
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mostra struttura file dopo il checkout
        run: tree -a -L 3 || true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          check-latest: true

      - name: Installa dipendenze
        run: pip install requests packaging

      - name: Genera versione
        run: python tools/version/leeno_version_generator.py
        env:
          GITHUB_SHA: ${{ github.sha }}
          BUILD_NUMBER: ${{ github.run_number }}
        working-directory: ${{ github.workspace }}

      - name: Verifica output
        run: |
          cat src/Ultimus.oxt/leeno_version_code
          cat include/version.h

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y sshpass rsync

      # - name: Upload files
      #   run: |
      #     # Crea la directory remota se non esiste
      #     sshpass -p "${{ secrets.SFTP_PASS }}" ssh -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT || 22 }} \
      #       ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} \
      #       "mkdir -p ${{ secrets.SFTP_REMOTE_PATH }}"
          
      #     # Upload dei file
      #     sshpass -p "${{ secrets.SFTP_PASS }}" rsync -avz \
      #       -e "ssh -p ${{ secrets.SFTP_PORT || 22 }} -o StrictHostKeyChecking=no" \
      #       include/version.h \
      #       src/Ultimus.oxt/leeno_version_code \
      #       ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }}:${{ secrets.SFTP_REMOTE_PATH }}/

      - name: Upload files to SFTP
        run: |
          # File da trasferire
          FILES=(
            "include/version.h"
            "src/Ultimus.oxt/leeno_version_code"
            "tools/version/versions.html"
          )
          
          # Verifica che i file esistano
          for file in "${FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERRORE: File $file non trovato!"
              ls -la $(dirname "$file")
              exit 1
            fi
          done
          
          # Trasferimento con rsync
          sshpass -p "${{ secrets.SFTP_PASSWORD }}" rsync -avz \
            -e "ssh -p ${{ secrets.SFTP_PORT || 22 }} -o StrictHostKeyChecking=no" \
            "${FILES[@]}" \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }}:${{ secrets.SFTP_REMOTE_PATH }}/
          
          # Verifica remota
          sshpass -p "${{ secrets.SFTP_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
            -p ${{ secrets.SFTP_PORT || 22 }} \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} \
            "ls -la ${{ secrets.SFTP_REMOTE_PATH }}/versions.html"

      - name: Verify upload
        run: |
          sshpass -p "${{ secrets.SFTP_PASS }}" ssh -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT || 22 }} \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} \
            "ls -la ${{ secrets.SFTP_REMOTE_PATH }}/version.h ${{ secrets.SFTP_REMOTE_PATH }}/leeno_version_code"