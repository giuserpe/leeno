name: Genera versioni LeenO con archivio .oxt

on:
  push:
    branches: [dev]
  workflow_dispatch:

env:
  SFTP_REMOTE_PATH: "/path/to/remote"  # Sovrascritto dal secret
  SFTP_PORT: "22"                      # Sovrascritto dal secret

jobs:
  generate_version:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Installa dipendenze
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          pip install requests

      - name: Verifica connessione SFTP
        run: |
          echo "=== Verifica connessione ==="
          sshpass -p "${{ secrets.SFTP_PASS }}" ssh \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.SFTP_PORT || 22 }} \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} \
            "cd ${{ secrets.SFTP_REMOTE_PATH }} && pwd && echo 'Contenuto:' && ls -la"

      - name: Recupera elenco file .oxt
        id: oxt_files
        run: |
          echo "=== Debug Inizio ==="
          echo "Remote Path: ${{ secrets.SFTP_REMOTE_PATH }}"
          echo "Host: ${{ secrets.SFTP_HOST }}"
          
          # Comando di ricerca piÃ¹ robusto
          set +e
          sshpass -p "${{ secrets.SFTP_PASS }}" ssh \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.SFTP_PORT || 22 }} \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} \
            "cd '${{ secrets.SFTP_REMOTE_PATH }}' && find . -maxdepth 1 -name '*.oxt' -printf '%TY-%Tm-%Td %TH:%TM %kKB %p\n' | sort -r | head -10" > oxt_list.txt
          
          # Verifica risultati
          echo "=== Contenuto oxt_list.txt ==="
          cat oxt_list.txt
          OXT_COUNT=$(wc -l < oxt_list.txt | tr -d ' ')
          
          # Crea file vuoto se nessun risultato
          if [ "$OXT_COUNT" -eq 0 ]; then
            echo "Nessun file .oxt trovato, uso fallback"
            echo "LeenO-0.0.0.0-EMPTY-19700101 0KB ./placeholder.oxt" > oxt_list.txt
            OXT_COUNT=1
          fi
          
          echo "count=$OXT_COUNT" >> $GITHUB_OUTPUT
          echo "list_path=${GITHUB_WORKSPACE}/oxt_list.txt" >> $GITHUB_OUTPUT
          echo "=== Debug Fine ==="

      - name: Setup ambiente
        run: |
          mkdir -p src/Ultimus.oxt
          mkdir -p include
          mkdir -p tools/version
          chmod -R 777 src include tools

      - name: Genera file versione
        run: python tools/version/leeno_version_generator.py
        env:
          GITHUB_SHA: ${{ github.sha }}
          BUILD_NUMBER: ${{ github.run_number }}
          OXT_LIST_PATH: ${{ steps.oxt_files.outputs.list_path }}
          SFTP_BASE_URL: "${{ secrets.SFTP_BASE_URL || 'https://download.example.com' }}"
        working-directory: ${{ github.workspace }}

      - name: Verifica output
        run: |
          echo "=== Version.h ==="
          cat include/version.h || echo "version.h non generato"
          echo "=== Versions.html ==="
          grep -A 20 "Archivio Versioni" tools/version/versions.html || echo "Nessuna tabella trovata"
          echo "=== File generati ==="
          ls -lR src/Ultimus.oxt include tools/version

      - name: Upload files
        if: steps.oxt_files.outputs.count > 0
        run: |
          sshpass -p "${{ secrets.SFTP_PASS }}" scp \
            -o StrictHostKeyChecking=no \
            -P ${{ secrets.SFTP_PORT || 22 }} \
            src/Ultimus.oxt/leeno_version_code \
            include/version.h \
            tools/version/versions.html \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }}:${{ secrets.SFTP_REMOTE_PATH }}/

      - name: Post-upload verification
        if: steps.oxt_files.outputs.count > 0
        run: |
          echo "=== File remoti ==="
          sshpass -p "${{ secrets.SFTP_PASS }}" ssh \
            -o StrictHostKeyChecking=no \
            -p ${{ secrets.SFTP_PORT || 22 }} \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} \
            "ls -l ${{ secrets.SFTP_REMOTE_PATH }}/version.h \
                   ${{ secrets.SFTP_REMOTE_PATH }}/leeno_version_code \
                   ${{ secrets.SFTP_REMOTE_PATH }}/versions.html"