name: Genera e pubblica versioni LeenO

on:
  push:
    branches: [dev]
  workflow_dispatch:

jobs:
  generate_version:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Installa dipendenze
        run: |
          pip install requests
          sudo apt-get update
          sudo apt-get install -y sshpass lftp

      - name: Genera versioni
        run: python tools/version/leeno_version_generator.py
        env:
          GITHUB_SHA: ${{ github.sha }}
          BUILD_NUMBER: ${{ github.run_number }}
        working-directory: ${{ github.workspace }}

      - name: Verifica file generati
        run: |
          echo "=== File generati ==="
          ls -la src/Ultimus.oxt/leeno_version_code \
               include/version.h \
               tools/version/versions.html
          echo "=== Contenuto versions.html ==="
          head -n 15 tools/version/versions.html

      - name: Setup SFTP
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SFTP_HOST }} ssh-rsa AAAAB3NzaC1yc2E..." >> ~/.ssh/known_hosts

      - name: Upload files
        run: |
          lftp -u "${{ secrets.SFTP_USER }},${{ secrets.SFTP_PASS }}" \
          sftp://${{ secrets.SFTP_HOST }} <<EOF
          set sftp:auto-confirm yes
          mkdir -p ${{ secrets.SFTP_REMOTE_PATH }}
          put $GITHUB_WORKSPACE/include/version.h -o ${{ secrets.SFTP_REMOTE_PATH }}/version.h
          put $GITHUB_WORKSPACE/src/Ultimus.oxt/leeno_version_code -o ${{ secrets.SFTP_REMOTE_PATH }}/leeno_version_code
          put $GITHUB_WORKSPACE/tools/version/versions.html -o ${{ secrets.SFTP_REMOTE_PATH }}/versions.html
          bye
          EOF

      - name: Verifica upload
        run: |
          sshpass -p "${{ secrets.SFTP_PASS }}" ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} \
            "ls -la ${{ secrets.SFTP_REMOTE_PATH }}/version.h \
                   ${{ secrets.SFTP_REMOTE_PATH }}/leeno_version_code \
                   ${{ secrets.SFTP_REMOTE_PATH }}/versions.html"