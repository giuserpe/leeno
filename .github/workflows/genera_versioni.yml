name: Genera pagina versioni LeenO

on:
  push:
    branches:
      - dev
  workflow_dispatch:

jobs:
  generate_version:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout codice
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y lftp sshpass

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          # Rimossa la cache pip poich√© non abbiamo requirements.txt
          check-latest: true  # Meglio usare sempre l'ultima versione patch

      - name: Installa dipendenze
        run: pip install requests packaging

      - name: Verifica struttura repository
        run: |
          echo "Struttura repository:"
          ls -R --group-directories-first
          echo -e "\nContenuto di tools/version:"
          ls -la tools/version

      - name: Genera versione
        run: python tools/version/leeno_version_generator.py
        env:
          GITHUB_SHA: ${{ github.sha }}
          BUILD_NUMBER: ${{ github.run_number }}  # Usa il numero della run come build number
        working-directory: ${{ github.workspace }}

      - name: Verifica output
        run: |
          echo "Contenuto aggiornato:"
          cat src/Ultimus.oxt/leeno_version_code
          echo -e "\nVersion header:"
          cat include/version.h


      - name: Verifica file da caricare
        run: |
          echo "File in include/:"
          ls -la include/
          echo -e "\nContenuto di leeno_version_code:"
          cat src/Ultimus.oxt/leeno_version_code || true


      - name: Install LFTP
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Test SFTP Connection
        run: |
          echo "open sftp://${{ secrets.SFTP_USER }}:${{ secrets.SFTP_PASSWORD }}@${{ secrets.SFTP_HOST }}
          ls ${{ secrets.SFTP_REMOTE_PATH }}
          bye" | lftp -e "set sftp:auto-confirm yes; set ftp:ssl-allow no"

      - name: Upload files
        run: |
          lftp -u "${{ secrets.SFTP_USER }}","${{ secrets.SFTP_PASSWORD }}" \
          sftp://${{ secrets.SFTP_HOST }} <<EOF
          set sftp:auto-confirm yes
          mkdir -p ${{ secrets.SFTP_REMOTE_PATH }}
          put include/version.h -o ${{ secrets.SFTP_REMOTE_PATH }}/version.h
          put src/Ultimus.oxt/leeno_version_code -o ${{ secrets.SFTP_REMOTE_PATH }}/leeno_version_code
          bye
          EOF

      - name: Set correct permissions
        run: |
            chmod 644 include/version.h
            chmod 644 src/Ultimus.oxt/leeno_version_code
      - name: Verify upload
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SFTP_PORT || '22' }} ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} "ls -la ${{ secrets.SFTP_REMOTE_PATH }}/version.h"