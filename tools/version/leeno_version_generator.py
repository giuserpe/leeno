#!/usr/bin/env python3
"""
Script aggiornato per il formato specifico LeenO-3.24.2.210-TESTING-20250720
"""

import os
import re
from datetime import datetime
from pathlib import Path

def parse_version_code():
    """Analizza la stringa di versione nel formato LeenO-3.24.2.210-TESTING-20250720"""
    version_file = Path(__file__).parent.parent.parent / 'src' / 'Ultimus.oxt' / 'leeno_version_code'
    try:
        with open(version_file, 'r') as f:
            version_str = f.read().strip()
            
            match = re.match(
                r'^LeenO-(?P<major>\d+)\.(?P<minor>\d+)\.(?P<patch>\d+)\.(?P<build>\d+)-TESTING-(?P<date>\d+)$',
                version_str
            )
            
            if not match:
                raise ValueError(f"Formato versione non riconosciuto: {version_str}")
                
            return {
                'full': version_str,
                'major': match.group('major'),
                'minor': match.group('minor'),
                'patch': match.group('patch'),
                'build': match.group('build'),
                'date': match.group('date'),
                'semver': f"{match.group('major')}.{match.group('minor')}.{match.group('patch')}"
            }
            
    except Exception as e:
        print(f"ERRORE analizzando leeno_version_code: {str(e)}")
        print("Il formato atteso Ã¨: LeenO-MAJOR.MINOR.PATCH.BUILD-TESTING-DATA")
        raise

def generate_new_version(version_info):
    """Genera la nuova stringa di versione"""
    now = datetime.utcnow()
    build_number = os.getenv('BUILD_NUMBER', version_info['build'])
    git_sha = os.getenv('GITHUB_SHA', 'local')[:7]
    
    return {
        'full': f"LeenO-{version_info['major']}.{version_info['minor']}.{version_info['patch']}.{build_number}-TESTING-{now.strftime('%Y%m%d')}",
        'build_number': build_number,
        'build_date': now.strftime("%Y-%m-%d"),
        'build_time': now.strftime("%H:%M:%S"),
        'git_sha': git_sha
    }

def update_version_file(new_version):
    """Aggiorna il file leeno_version_code"""
    version_file = Path(__file__).parent.parent.parent / 'src' / 'Ultimus.oxt' / 'leeno_version_code'
    
    with open(version_file, 'w') as f:
        f.write(new_version['full'])

def generate_version_header(version_info, build_info):
    """Genera il file version.h per C++"""
    include_dir = Path(__file__).parent.parent.parent / 'include'
    include_dir.mkdir(exist_ok=True)
    
    header_content = f"""// Auto-generated by version generator
#ifndef LEENO_VERSION_H
#define LEENO_VERSION_H

#define LEENO_VERSION_MAJOR {version_info['major']}
#define LEENO_VERSION_MINOR {version_info['minor']}
#define LEENO_VERSION_PATCH {version_info['patch']}
#define LEENO_VERSION_BUILD {build_info['build_number']}
#define LEENO_VERSION_STRING "{version_info['semver']}"
#define LEENO_VERSION_FULL "{version_info['full']}"
#define LEENO_BUILD_NUMBER "{build_info['build_number']}"
#define LEENO_BUILD_DATE "{build_info['build_date']}"
#define LEENO_BUILD_TIME "{build_info['build_time']}"
#define LEENO_GIT_SHA "{build_info['git_sha']}"

#endif // LEENO_VERSION_H
"""
    
    with open(include_dir / 'version.h', 'w') as f:
        f.write(header_content)

def main():
    try:
        print("Generazione informazioni versione Leeno...")
        
        # Analizza la versione esistente
        version_info = parse_version_code()
        print(f"Versione corrente: {version_info['full']}")
        
        # Genera nuove informazioni
        build_info = generate_new_version(version_info)
        print(f"Nuova versione: {build_info['full']}")
        print(f"Build number: {build_info['build_number']}")
        print(f"Git SHA: {build_info['git_sha']}")
        
        # Aggiorna i file
        update_version_file(build_info)
        generate_version_header(version_info, build_info)
        
        print("File versione generati con successo!")
        return 0
        
    except Exception as e:
        print(f"ERRORE: {str(e)}")
        return 1

if __name__ == "__main__":
    exit(main())